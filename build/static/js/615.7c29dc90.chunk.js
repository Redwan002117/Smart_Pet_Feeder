"use strict";(self.webpackChunksmart_pet_feeder=self.webpackChunksmart_pet_feeder||[]).push([[615],{615:(e,s,a)=>{a.r(s),a.d(s,{default:()=>l});var i=a(43),c=a(662),n=a(584),d=a(579);const l=()=>{const[e,s]=(0,i.useState)([]),[a,l]=(0,i.useState)(!0),[t,r]=(0,i.useState)(null),[o,m]=(0,i.useState)(null),[v,h]=(0,i.useState)(null),[u,N]=(0,i.useState)("");(0,i.useEffect)((()=>{x();const e=n.N.channel("devices-changes").on("postgres_changes",{event:"*",schema:"public",table:"devices"},j).subscribe();return()=>{e.unsubscribe()}}),[]);const x=async()=>{try{l(!0);const{data:{user:e}}=await n.N.auth.getUser();if(!e)throw new Error("User not authenticated");const{data:a,error:i}=await n.N.from("devices").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(i)throw i;s(a||[])}catch(e){console.error("Error fetching devices:",e),r(e.message||"Failed to load devices")}finally{l(!1)}},j=e=>{const{eventType:a,new:i,old:c}=e;"INSERT"===a?s((e=>[i,...e])):"UPDATE"===a?s((e=>e.map((e=>e.device_id===i.device_id?i:e)))):"DELETE"===a&&s((e=>e.filter((e=>e.device_id!==c.device_id))))},f=e=>{var s,a;const i=(null===(s=e.last_status)||void 0===s?void 0:s.food_level)||0,c=null===(a=e.last_status)||void 0===a?void 0:a.last_update;return c&&Date.now()/1e3-parseInt(c)<300?i<20?(0,d.jsx)("span",{className:"status-badge warning",children:"Low Food"}):(0,d.jsx)("span",{className:"status-badge online",children:"Online"}):(0,d.jsx)("span",{className:"status-badge offline",children:"Offline"})},b=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,s=0;return s=e<-80?1:e<-70?2:e<-60?3:4,(0,d.jsx)("div",{className:"wifi-strength-icon",children:Array.from({length:4}).map(((e,a)=>(0,d.jsx)("div",{className:"wifi-bar "+(a<s?"active":"")},a)))})};return a?(0,d.jsxs)("div",{className:"loading-container",children:[(0,d.jsx)("div",{className:"loading-spinner"}),(0,d.jsx)("p",{children:"Loading devices..."})]}):(0,d.jsxs)("div",{className:"devices-container",children:[(0,d.jsxs)("div",{className:"devices-header",children:[(0,d.jsx)("h1",{children:"My Devices"}),(0,d.jsxs)(c.N_,{to:"/device-setup",className:"btn btn-primary",children:[(0,d.jsx)("i",{className:"icon-plus"})," Add Device"]})]}),t&&(0,d.jsxs)("div",{className:"error-alert",children:[(0,d.jsx)("i",{className:"icon-warning"}),(0,d.jsx)("p",{children:t}),(0,d.jsx)("button",{className:"error-close",onClick:()=>r(null),children:"\xd7"})]}),0===e.length?(0,d.jsxs)("div",{className:"no-devices",children:[(0,d.jsx)("div",{className:"no-devices-icon",children:(0,d.jsx)("i",{className:"icon-device-off"})}),(0,d.jsx)("h2",{children:"No devices found"}),(0,d.jsx)("p",{children:"Get started by adding your first Pet Feeder device."}),(0,d.jsx)(c.N_,{to:"/device-setup",className:"btn btn-primary",children:"Set Up New Device"})]}):(0,d.jsx)("div",{className:"devices-grid",children:e.map((e=>{var s,a,i;const c=(null===(s=e.last_status)||void 0===s?void 0:s.food_level)||0,l=(null===(a=e.last_status)||void 0===a?void 0:a.wifi_strength)||0,t=null!==(i=e.last_status)&&void 0!==i&&i.last_update?new Date(1e3*parseInt(e.last_status.last_update)).toLocaleString():"Never";return(0,d.jsxs)("div",{className:"device-card",children:[(0,d.jsxs)("div",{className:"device-card-header",children:[(0,d.jsx)("h3",{children:e.device_name}),f(e)]}),(0,d.jsxs)("div",{className:"device-card-content",children:[(0,d.jsxs)("div",{className:"device-metric",children:[(0,d.jsx)("div",{className:"metric-label",children:"Food Level"}),(0,d.jsxs)("div",{className:"progress-bar",children:[(0,d.jsx)("div",{className:"progress-fill",style:{width:`${c}%`}}),(0,d.jsxs)("span",{className:"progress-text",children:[c,"%"]})]})]}),(0,d.jsxs)("div",{className:"device-metric",children:[(0,d.jsx)("div",{className:"metric-label",children:"WiFi Signal"}),(0,d.jsxs)("div",{className:"wifi-container",children:[b(l),(0,d.jsxs)("span",{className:"wifi-text",children:[l," dBm"]})]})]}),(0,d.jsxs)("div",{className:"device-metric",children:[(0,d.jsx)("div",{className:"metric-label",children:"Last Update"}),(0,d.jsx)("div",{className:"metric-value",children:t})]}),(0,d.jsxs)("div",{className:"device-metric",children:[(0,d.jsx)("div",{className:"metric-label",children:"Added On"}),(0,d.jsx)("div",{className:"metric-value",children:(o=e.created_at,new Date(o).toLocaleDateString())})]})]}),(0,d.jsxs)("div",{className:"device-card-actions",children:[(0,d.jsx)("button",{className:"btn btn-icon",onClick:()=>{h(e),N(e.device_name)},title:"Edit Device",children:(0,d.jsx)("i",{className:"icon-edit"})}),(0,d.jsx)("button",{className:"btn btn-icon btn-warning",onClick:()=>async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{const{error:a}=await n.N.from("devices").update({last_status:{...e.last_status,command:"dispense",command_amount:s}}).eq("device_id",e.device_id);if(a)throw a;const{error:i}=await n.N.from("feeding_history").insert([{device_id:e.device_id,time:(new Date).toISOString(),amount:s,manual:!0}]);if(i)throw i;alert(`Dispensing ${s}g of food from ${e.device_name}!`)}catch(a){console.error("Error dispensing food:",a),r(`Failed to dispense food: ${a.message}`)}}(e),title:"Dispense Food",children:(0,d.jsx)("i",{className:"icon-food"})}),(0,d.jsx)("button",{className:"btn btn-icon btn-danger",onClick:()=>m(e.device_id),title:"Delete Device",children:(0,d.jsx)("i",{className:"icon-trash"})})]})]},e.device_id);var o}))}),v&&(0,d.jsx)("div",{className:"modal-overlay",children:(0,d.jsxs)("div",{className:"modal-content",children:[(0,d.jsxs)("div",{className:"modal-header",children:[(0,d.jsx)("h2",{children:"Edit Device"}),(0,d.jsx)("button",{className:"modal-close",onClick:()=>h(null),children:"\xd7"})]}),(0,d.jsx)("div",{className:"modal-body",children:(0,d.jsxs)("div",{className:"form-group",children:[(0,d.jsx)("label",{htmlFor:"device-name",children:"Device Name"}),(0,d.jsx)("input",{id:"device-name",type:"text",value:u,onChange:e=>N(e.target.value),placeholder:"Enter device name"})]})}),(0,d.jsxs)("div",{className:"modal-footer",children:[(0,d.jsx)("button",{className:"btn btn-outline",onClick:()=>h(null),children:"Cancel"}),(0,d.jsx)("button",{className:"btn btn-primary",onClick:async()=>{if(v)try{const{error:e}=await n.N.from("devices").update({device_name:u}).eq("device_id",v.device_id);if(e)throw e;h(null)}catch(e){console.error("Error updating device name:",e),r(`Failed to update device name: ${e.message}`)}},children:"Save Changes"})]})]})}),o&&(0,d.jsx)("div",{className:"modal-overlay",children:(0,d.jsxs)("div",{className:"modal-content",children:[(0,d.jsxs)("div",{className:"modal-header",children:[(0,d.jsx)("h2",{children:"Confirm Deletion"}),(0,d.jsx)("button",{className:"modal-close",onClick:()=>m(null),children:"\xd7"})]}),(0,d.jsx)("div",{className:"modal-body",children:(0,d.jsx)("p",{className:"confirm-message",children:"Are you sure you want to delete this device? This action cannot be undone."})}),(0,d.jsxs)("div",{className:"modal-footer",children:[(0,d.jsx)("button",{className:"btn btn-outline",onClick:()=>m(null),children:"Cancel"}),(0,d.jsx)("button",{className:"btn btn-danger",onClick:()=>(async e=>{try{const{error:s}=await n.N.from("devices").delete().eq("device_id",e);if(s)throw s;m(null)}catch(s){console.error("Error deleting device:",s),r(`Failed to delete device: ${s.message}`)}})(o),children:"Delete Device"})]})]})})]})}}}]);
//# sourceMappingURL=615.7c29dc90.chunk.js.map